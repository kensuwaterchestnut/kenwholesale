<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>啃酥｜嘉南菱角酥職人・批發零售</title>
<meta name="description" content="啃酥：嘉南產地直送菱角酥，職人每日現炸，支援團媽/禮盒/通路批發。">
<style>
  :root{
    --bg:#faf7f2; --surface:#ffffff; --text:#1f2937; --muted:#6b7280;
    --brand:#f59e0b; --brand-dark:#d97706; --border:#e5e7eb; --shadow:0 10px 28px rgba(0,0,0,.06);
    --hot:#ef4444; --hot-dark:#dc2626; --pongan-surface:#fff7d6; --maogao-surface:#eef9f0;
    --sold:#111; --sold-bg:rgba(17,17,17,.55);
  }
  *{box-sizing:border-box}
  html{scroll-behavior:smooth; -webkit-text-size-adjust:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif}
  a{color:var(--brand-dark);text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:0 16px}

  /* Hero */
  .hero{position:relative;min-height:52vh;display:grid;place-items:center;color:#fff;background-size:cover;background-position:center}
  @media(max-width:560px){.hero{min-height:44vh}}
  .hero::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.38));z-index:0;pointer-events:none}
  .hero-inner{position:relative;z-index:1;text-align:center;padding:56px 16px}
  .logo{width:110px;height:110px;border-radius:18px;background:#fff9;padding:10px;backdrop-filter:blur(4px);display:inline-grid;place-items:center;margin-bottom:10px}
  .logo img{max-width:100%;max-height:100%}
  .hero h1{font-size:clamp(21px,4.8vw,36px);margin:4px 0 6px}
  .hero p{font-size:clamp(12.5px,3.2vw,15px);opacity:.98;margin:0}
  .pill{display:inline-block;background:#fff3;backdrop-filter:blur(4px);border:1px solid #fff7;color:#fff;border-radius:999px;padding:6px 10px;font-weight:700}

  .btn{display:inline-flex;align-items:center;gap:8px;border-radius:12px;padding:10px 14px;background:var(--brand);color:#111;font-weight:700;border:1px solid rgba(0,0,0,.05);box-shadow:0 10px 20px rgba(245,158,11,.25);cursor:pointer;font-size:clamp(12.5px,3vw,15px)}
  .btn:hover{background:var(--brand-dark)}
  .btn-ghost{background:#f9fafb;border:1px solid var(--border);color:var(--text);box-shadow:none}
  .btn-ghost:hover{background:#f3f4f6}
  .btn-red{background:var(--hot);color:#fff;border-color:#ef4444;box-shadow:0 10px 20px rgba(239,68,68,.25)}
  .btn-red:hover{background:var(--hot-dark)}
  .btn-block{width:100%;justify-content:center}

  .section{padding:34px 0}
  .section h2{font-size:clamp(17px,3.8vw,25px);margin:0 0 10px}
  .muted{color:var(--muted)}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
  .content{padding:16px}
  .content p{margin:0 0 10px;line-height:1.8;font-size:clamp(13.5px,3.2vw,15px)}
  .content ul{margin:0;padding-left:1.2em;line-height:1.8}
  .content li{margin:4px 0}
  .note{font-size:12.5px;color:var(--muted)}

  /* 分類籤：單排橫向滑動 */
  .subnav{position:sticky;top:0;z-index:40;background:var(--surface);border-bottom:1px solid var(--border);box-shadow:0 6px 20px rgba(0,0,0,.04)}
  .subnav .rail{display:flex;gap:8px;align-items:center;padding:10px 4px;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;scroll-snap-type:x proximity}
  .subnav .rail::-webkit-scrollbar{height:6px}
  .subnav .rail::-webkit-scrollbar-thumb{background:#e6e6e6;border-radius:999px}
  .chip{flex:0 0 auto;background:#fef3c7;border:1px solid #fde68a;color:#7c2d12;padding:8px 12px;border-radius:12px;font-weight:800;cursor:pointer;scroll-snap-align:center;font-size:clamp(12.5px,3vw,14px)}
  .chip:hover{background:#fde68a}

  /* 橫向滑動卡片（新聞/規格共用） */
  .rail-cards{display:flex;gap:12px;overflow:auto;padding:10px 4px}
  .rail-cards::-webkit-scrollbar{height:6px}
  .rail-cards::-webkit-scrollbar-thumb{background:#e6e6e6;border-radius:999px}
  .rail-cards .card{flex:0 0 auto;width:min(480px,92%)}
  .spec-cards .card{width:min(360px,48%)}
  @media(min-width:900px){.spec-cards .card{width:min(420px,32%)}}

  /* 產品網格（兩欄） */
  .product-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media(min-width:960px){.product-grid{gap:14px}}
  .product{display:flex;flex-direction:column;position:relative}
  .product .imgwrap{position:relative}
  .product img{width:100%;aspect-ratio:4/3;height:auto;object-fit:cover;border-radius:14px 14px 0 0}
  .sold-badge{position:absolute;inset:0;display:grid;place-items:center;background:var(--sold-bg);color:#fff;font-weight:900;border-radius:14px 14px 0 0;font-size:18px;letter-spacing:2px}
  .product .body{padding:10px 12px}
  .title{margin:0;font-weight:700;font-size:clamp(12.5px,3.5vw,15px);line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:2.4em}
  .price{font-weight:800;font-size:clamp(14px,3.8vw,16px)}
  .row-between{display:flex;align-items:center;justify-content:space-between}
  .tag-hot{display:inline-block;background:var(--hot);color:#fff;border:1px solid #ef4444;border-radius:10px;padding:3px 7px;font-size:12px;font-weight:800}

  /* 區塊主題（延用） */
  .theme-hot .content{background:#fee2e2;border-color:#fecaca}
  .theme-pongan .content{background:#fff7e6;border-color:#fde68a}
  .theme-maogao .content{background:#eef9f0;border-color:#bbf7d0}

  /* 抽屜（共用） */
  .drawer{position:fixed;right:0;top:0;bottom:0;width:min(480px,96%);background:var(--surface);border-left:1px solid var(--border);
    transform:translateX(105%);transition:.28s;z-index:60;display:flex;flex-direction:column}
  .drawer.open{transform:none}
  .drawer header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:8px}
  .drawer header .btns{display:flex;gap:8px}
  .drawer main{padding:12px 14px;overflow:auto;flex:1}
  .line{height:1px;background:var(--border);margin:10px 0}

  .cart-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 0}
  .qty{display:flex;align-items:center;border:1px solid var(--border);border-radius:10px}
  .qty button{width:30px;height:30px;border:0;background:#f3f4f6}
  .qty span{display:inline-block;width:32px;text-align:center}

  .summary{background:#f9fafb;border:1px dashed var(--border);border-radius:12px;padding:12px}
  .badge{display:inline-block;background:#fff0d6;color:#7c2d12;border:1px solid #fed7aa;border-radius:10px;padding:4px 8px;font-size:12px;font-weight:700}
  .warn{background:#fff1f2;border:1px solid #fecdd3;color:#7f1d1d}

  /* 表單 */
  .form .row{display:grid;gap:10px}
  @media(min-width:720px){.form .row{grid-template-columns:1fr 1fr}}
  .label{font-weight:700;margin:8px 0 6px}
  .input, select, textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:16px}
  input, select, textarea{touch-action:manipulation}
  .help{font-size:12px;color:#6b7280;margin-top:4px}

  /* 浮動購物車（改成🍊） */
  .fab{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom));z-index:55;background:var(--brand);color:#111;border:1px solid rgba(0,0,0,.06);
    padding:12px 16px;border-radius:999px;box-shadow:0 10px 18px rgba(245,158,11,.35);display:flex;align-items:center;gap:8px;font-weight:800;cursor:pointer}
  .fab .icon{font-size:18px}
  .fab-badge{display:inline-block;min-width:22px;height:22px;border-radius:999px;background:#111;color:#fff;font-size:12px;line-height:22px;text-align:center;padding:0 6px}

  /* 不起眼的管理員按鈕（左下角） */
  .admin-btn{position:fixed;left:14px;bottom:calc(16px + env(safe-area-inset-bottom));z-index:56;background:#fff;border:1px solid var(--border);border-radius:999px;box-shadow:var(--shadow);padding:8px 10px;opacity:.5;cursor:pointer}
  .admin-btn:hover{opacity:.9}

  /* 右下角齒輪（庫存編輯） */
  .gear{position:fixed;right:16px;bottom:calc(68px + env(safe-area-inset-bottom));z-index:55;background:#fff;border:1px solid var(--border);border-radius:999px;box-shadow:var(--shadow);padding:10px 12px;cursor:pointer}

  /* Toast */
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(86px + env(safe-area-inset-bottom));background:#111;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:var(--shadow);z-index:70;opacity:0;pointer-events:none;transition:.25s}
  .toast.show{opacity:1;transform:translate(-50%,-8px)}

  footer{padding:34px 0 56px;color:#6b7280;text-align:center}
</style>
</head>
<body>

<!-- 購物車抽屜 -->
<aside id="drawer" class="drawer" aria-hidden="true">
  <header>
    <strong>購物車</strong>
    <div class="btns">
      <button class="btn-ghost" onclick="clearCart()">清空購物車</button>
      <button class="btn" onclick="toggleDrawer(false)">關閉</button>
    </div>
  </header>
  <main>
    <div id="cartList"></div>

    <div class="line"></div>

    <!-- 配送方式 -->
    <div class="summary" style="margin-bottom:10px">
      <div class="label">配送方式</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="shipHomeBtn" class="btn" type="button" onclick="setShipMethod('HOME')">宅配</button>
        <button id="shipCvsBtn" class="btn-ghost" type="button" onclick="setShipMethod('CVS')">超商取貨（免運｜限10斤×1）</button>
      </div>
      <div class="help">
        超商取貨限「單一 10 台斤 × 1 箱」。<br>
        <span class="badge">選門市小幫手</span> 會以「新視窗」開啟官方查詢；選好後回到此頁，按「貼上剪貼簿」可自動帶入。
      </div>
    </div>

    <!-- 運費與總額 -->
    <div class="summary">
      <div class="row-between"><span>商品小計</span><strong id="subtotal">$0</strong></div>
      <div class="row-between"><span id="shipLabel">運費（宅配）</span><strong id="shipping">$0</strong></div>
      <div class="line"></div>
      <div class="row-between" style="font-size:18px"><span>應付金額</span><strong id="total">$0</strong></div>
      <div class="note" style="margin-top:8px">宅配滿額 <b id="freeShipText">0</b> 免運；超商取貨一律免運。</div>
    </div>

    <div class="line"></div>

    <!-- 下單表單 -->
    <form id="orderForm" class="form" onsubmit="submitOrder(event)">
      <div class="row">
        <div>
          <div class="label">姓名</div>
          <input class="input" name="name" placeholder="例：王啃酥" required>
        </div>
        <div>
          <div class="label">手機</div>
          <input class="input" name="phone" placeholder="例：0912-345-678" required>
        </div>
      </div>
      <div class="row">
        <div>
          <div class="label">Email（寄送出貨通知）</div>
          <input class="input" type="email" name="email" placeholder="例：kensu@example.com" required>
        </div>
        <div>
          <div class="label">物流方式</div>
          <select name="ship" class="input" required>
            <option value="宅配">宅配</option>
            <option value="超商取貨">超商取貨（免運｜限10斤×1）</option>
            <option value="自取（台南官田：面交點）">自取（台南官田：面交點）</option>
          </select>
          <div class="help">此欄會跟上方「配送方式」同步。</div>
        </div>
      </div>

      <!-- 地址／超商 -->
      <div id="homeFields">
        <div class="label">收件地址（宅配專用）</div>
        <input class="input" name="addr" placeholder="例：台南市○○區○○路 123 號 5 樓" required>
      </div>

      <div id="cvsFields" style="display:none">
        <div class="row">
          <div>
            <div class="label">超商品牌（7-11／全家）</div>
            <select class="input" name="cvsBrand" onchange="updateCvsLink()">
              <option value="7-11">7-11</option>
              <option value="全家">全家</option>
            </select>
            <div class="help">
              <a id="cvsFinderLink" href="https://emap.pcsc.com.tw/" target="_blank" rel="noopener">開啟 7-11 門市查詢（新視窗）</a>　
              <button type="button" class="btn-ghost" onclick="pasteCvsFromClipboard()">貼上剪貼簿</button>
            </div>
          </div>
          <div>
            <div class="label">門市名稱 / 店號</div>
            <input class="input" name="cvsStore" placeholder="例：台南官田門市 / 123456">
            <div class="help">先到官方查詢頁選好門市，再回來按「貼上剪貼簿」自動回填；或手動輸入。</div>
          </div>
        </div>
      </div>

      <div>
        <div class="label">備註（到貨時段等）</div>
        <textarea class="input" name="remark" rows="3" placeholder="例：平日 18:00 後收件"></textarea>
      </div>

      <!-- 同意條款 -->
      <div class="line"></div>
      <div class="label">物流與退貨說明</div>
      <details id="policy" class="card content" style="max-height:220px;overflow:auto">
        <summary style="cursor:pointer"><b>請展開閱讀（需捲到最底才可勾選同意）</b></summary>
        <div class="content" style="padding-top:10px">
          <ul>
            <li>入帳後 1–3 個工作天內出貨（週末與節慶量大時順延）。</li>
            <li>宅配：新竹貨運（常溫）。到貨請「全程開箱錄影」。若有運損，<b>24 小時內提供影片與照片</b>，我們協助向物流理賠。</li>
            <li>超商取貨：<b>免運</b>，<b>限單一 10 台斤 × 1 箱</b>，且目前<b>不接受外島配送</b>。</li>
            <li>菱角酥為油炸點心，建議冷凍保存，食用前以氣炸鍋或烤箱回溫。</li>
            <li>依食品衛生法，非因瑕疵恕不接受鑑賞期退換。</li>
          </ul>
          <p class="note">請確認上述內容，捲到底即可啟用同意勾選。</p>
        </div>
      </details>
      <div style="margin:8px 0">
        <label for="agree">
          <input type="checkbox" id="agree" disabled>
          我已詳閱<span style="text-decoration:underline">上方</span>「物流與退貨說明」並同意
        </label>
        <div class="help">（若未啟用，請先展開並捲到最底）</div>
      </div>

      <button id="submitBtn" class="btn btn-block" type="submit">送出訂單</button>
      <div id="result" class="note" style="margin-top:8px"></div>
    </form>
  </main>
</aside>

<!-- 訂單查詢抽屜 -->
<aside id="queryDrawer" class="drawer" aria-hidden="true">
  <header>
    <strong>訂單查詢</strong>
    <div class="btns">
      <button class="btn" onclick="toggleQuery(false)">關閉</button>
    </div>
  </header>
  <main>
    <form id="queryForm" onsubmit="queryOrder(event)" class="form">
      <div>
        <div class="label">訂單編號</div>
        <input class="input" name="orderNo" placeholder="例：K24-20251008-1234" required>
      </div>
      <button class="btn" type="submit" style="margin-top:8px">查詢</button>
    </form>
    <div class="line"></div>
    <div id="queryCard" class="card content" style="display:none"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="dlPngBtn" class="btn-ghost" onclick="downloadQueryPNG()" style="display:none">一鍵截圖（PNG）</button>
      <button id="printBtn" class="btn-ghost" onclick="window.print()" style="display:none">列印 / 存 PDF</button>
    </div>
  </main>
</aside>

<!-- 管理員抽屜（登入＋管理面板） -->
<aside id="adminDrawer" class="drawer" aria-hidden="true">
  <header>
    <strong>管理面板</strong>
    <div class="btns">
      <button class="btn-ghost" onclick="logoutAdmin()">登出</button>
      <button class="btn" onclick="toggleAdmin(false)">關閉</button>
    </div>
  </header>
  <main id="adminBody" class="content">
    <!-- 內容由 JS 依登入狀態渲染 -->
  </main>
</aside>

<!-- 浮動購物車按鈕（改橘子樣式） -->
<button id="cartFab" class="fab" aria-label="開啟購物車" onclick="toggleDrawer(true)">
  <span class="icon">🍊</span> 購物車 <span id="fabCount" class="fab-badge">0</span>
</button>

<!-- 不起眼的管理員按鈕 -->
<button class="admin-btn" onclick="toggleAdmin(true)" title="管理員">🔒</button>

<!-- 庫存編輯齒輪（未登入時會引導登入） -->
<button class="gear" onclick="toggleInvEdit()" title="庫存編輯">⚙️</button>

<!-- Hero -->
<section class="hero" id="hero">
  <div class="hero-inner wrap">
    <div class="logo"><img id="logoImg" src="" alt="啃酥 LOGO"></div>
    <span class="pill" id="heroPill">嘉南產地直送｜職人現炸</span>
    <h1 id="heroTitle">啃酥｜嘉南菱角酥職人・批發零售</h1>
    <p id="heroSub">團媽/通路/禮盒合作，冷凍保存、回烤即享酥香。支援大量出貨與企業客製。</p>
    <div style="margin-top:14px">
      <a id="shopNowBtn" class="btn" href="#hot" onclick="go(event,'hot')">馬上選購</a>
    </div>
  </div>
</section>

<!-- 分類錨點 -->
<nav class="subnav">
  <div class="wrap">
    <div class="rail" id="chipRail">
      <button class="chip" onclick="go(event,'hot')">🔥 熱銷款</button>
      <button class="chip" onclick="go(event,'pongan')">經典原味</button>
      <button class="chip" onclick="go(event,'maogao')">蒜香/胡椒</button>
      <button class="chip" onclick="toggleQuery(true)">訂單查詢</button>
    </div>
  </div>
</nav>

<!-- 品牌故事 + 最新鮮報 -->
<section class="section">
  <div class="wrap grid grid-2">
    <div class="card content" id="aboutCard">
      <h2 id="aboutTitle">關於「啃酥」</h2>
      <p id="aboutP1">我們只做一件事：把最酥的菱角酥，穩穩送到你手上。</p>
      <p id="aboutP2"><b>嘉南官田菱角</b>每日新鮮去殼與前處理，<b>職人控溫油炸</b>、低溫急凍，保留外酥內綿。</p>
      <p id="aboutP3">不論是團購、批發或禮盒，我們都能客製重量與口味。<br><b>酥香一口，回甘不膩。</b></p>
    </div>

    <div class="card content">
      <h2 id="newsTitle">最新鮮報｜油鍋日誌</h2>
      <div class="rail-cards" id="newsRail"></div>
    </div>
  </div>
</section>

<!-- 規格等級：獨立區塊 -->
<section class="section">
  <div class="wrap">
    <div class="card content" style="padding-bottom:0">
      <h2 id="specTitle">規格與口味</h2>
      <p class="muted" id="specSub" style="margin-top:-6px">每包皆附回烤說明，冷凍保存 3 個月</p>
    </div>
    <div class="rail-cards spec-cards" id="specRail" style="padding:10px 14px"></div>
  </div>
</section>

<!-- 熱銷 -->
<section id="hot" class="section theme-hot">
  <div class="wrap">
    <div class="card content" style="padding-bottom:0">
      <h2 id="hotTitle">🔥 熱銷款</h2>
      <p class="muted" id="hotSub" style="margin-top:-6px">通路與團媽最常下單的組合</p>
    </div>
    <div class="card" style="padding:0 14px 14px">
      <div id="hotGrid" class="product-grid"></div>
    </div>
  </div>
</section>

<!-- 分區一：經典原味 -->
<section id="pongan" class="section theme-pongan">
  <div class="wrap">
    <div class="card content" style="padding-bottom:0">
      <h2 id="sec1Title">經典原味（小農直送）</h2>
      <p class="muted" id="sec1Sub" style="margin-top:-6px">外酥內綿｜回甘不膩｜老少咸宜</p>
    </div>
    <div class="card" style="padding:0 14px 14px">
      <div id="ponganGrid" class="product-grid"></div>
    </div>
  </div>
</section>

<!-- 分區二：蒜香/胡椒 -->
<section id="maogao" class="section theme-maogao">
  <div class="wrap">
    <div class="card content" style="padding-bottom:0">
      <h2 id="sec2Title">蒜香 / 胡椒（下酒首選）</h2>
      <p class="muted" id="sec2Sub" style="margin-top:-6px">香氣濃郁｜越吃越涮嘴</p>
    </div>
    <div class="card" style="padding:0 14px 14px">
      <div id="maogaoGrid" class="product-grid"></div>
    </div>
  </div>
</section>

<!-- 匯款資訊 -->
<section class="section">
  <div class="wrap card content">
    <h2>匯款資訊</h2>
    <p><strong id="bankName"></strong>　戶名：<strong id="bankHolder"></strong></p>
    <p>帳號：<strong id="bankNo"></strong></p>
    <p class="note">
      詢價/合作信箱：<a href="mailto:kensu.water.chestnut@gmail.com" target="_blank">kensu.water.chestnut@gmail.com</a><br>
      批價試算表：<a href="https://docs.google.com/spreadsheets/d/1deY_CNcks1hJBxCrrDq9GfXEmDd5y53X8anLePb8ts8/edit?gid=0#gid=0" target="_blank">啃酥試算表（Google 試算表）</a>
    </p>
  </div>
</section>

<footer>
  <div class="wrap">
    <div class="content" style="text-align:center;padding-top:0">
      <div class="muted">© 啃酥｜嘉南菱角酥職人・批發零售</div>
      <div class="muted">面交點：台南市官田區（預約制）　|　客服：kensu.water.chestnut@gmail.com</div>
    </div>
  </div>
</footer>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite">已加入購物車</div>

<script>
/** =========================
 *  設定（全部可由管理員面板編輯）
 *  ========================= */
const CONFIG = {
  BRAND_TAG: "啃酥",
  CONTACT_EMAIL: "kensu.water.chestnut@gmail.com",
  SHEET_URL: "https://docs.google.com/spreadsheets/d/1deY_CNcks1hJBxCrrDq9GfXEmDd5y53X8anLePb8ts8/edit?gid=0#gid=0",
  GAS_ENDPOINT: "https://script.google.com/macros/s/AKfycbw5y8y1Yw7ymc7bP-iqV4KmxMB7l3c1wxMpPK1F6-d_vx_ejiIhCzhq0CyHPxDUNM92/exec",

  PRICES: {
    ORIGIN: { "500g": { "原味": 159 }, "1kg": { "原味": 299 } },
    FLAVOR: { "500g": { "蒜香": 169, "胡椒": 169 }, "1kg": { "蒜香": 319, "胡椒": 319 } }
  },

  SHIPPING: 160,
  FREE_SHIP_THRESHOLD: 1800,

  BANK: { name: "連線銀行(824)", holder: "張鈞泓", no: "11101-37823-13" },

  TEXTS: {
    heroPill:"嘉南產地直送｜職人現炸",
    heroTitle:"啃酥｜嘉南菱角酥職人・批發零售",
    heroSub:"團媽/通路/禮盒合作，冷凍保存、回烤即享酥香。支援大量出貨與企業客製。",
    ctaLabel:"馬上選購",
    chips:["🔥 熱銷款","經典原味","蒜香/胡椒","訂單查詢"],
    aboutTitle:"關於「啃酥」",
    aboutP1:"我們只做一件事：把最酥的菱角酥，穩穩送到你手上。",
    aboutP2:"嘉南官田菱角每日新鮮去殼與前處理，職人控溫油炸、低溫急凍，保留外酥內綿。",
    aboutP3:"不論是團購、批發或禮盒，我們都能客製重量與口味。酥香一口，回甘不膩。",
    newsTitle:"最新鮮報｜油鍋日誌",
    specTitle:"規格與口味",
    specSub:"每包皆附回烤說明，冷凍保存 3 個月",
    hotTitle:"🔥 熱銷款",
    hotSub:"通路與團媽最常下單的組合",
    sec1Title:"經典原味（小農直送）",
    sec1Sub:"外酥內綿｜回甘不膩｜老少咸宜",
    sec2Title:"蒜香 / 胡椒（下酒首選）",
    sec2Sub:"香氣濃郁｜越吃越涮嘴"
  },

  IMAGES: {
    HERO: toRaw("https://raw.githubusercontent.com/s9000721-cloud/gonglaoping/main/%E5%B0%81%E9%9D%A2%E5%9C%96.png"),
    LOGO: toRaw("https://raw.githubusercontent.com/s9000721-cloud/gonglaoping/main/%E6%9F%91%E5%BF%83%E6%9E%9C%E5%9C%92LOGO.png"),
    SPEC_GALLERY: [
      toRaw("https://via.placeholder.com/1200x800?text=%E5%8D%B1%E8%AD%A6%EF%BC%9A%E7%94%A8+%E7%9C%9F%E5%84%AA%E7%BE%8E+%E7%85%A7%E7%89%87%E6%9B%BF%E6%8F%9B"),
      "https://via.placeholder.com/1200x800?text=%E5%8F%A3%E5%91%B3%E8%A8%AD%E5%AE%9A",
      "https://via.placeholder.com/1200x800?text=%E5%9B%9E%E7%83%A4%E6%8C%87%E5%BC%95"
    ],
    NEWS: [
      {type:"video", src:"https://www.w3schools.com/html/mov_bbb.mp4", title:"今日油鍋溫度紀錄"},
      {type:"image", src:"https://via.placeholder.com/1200x800?text=%E7%94%A8%E7%85%A7%E7%89%87%E6%9B%BF%E6%8F%9B", title:"剛出鍋的金黃"},
      {type:"image", src:"https://via.placeholder.com/1200x800?text=%E8%A3%9D%E7%AE%B1%E7%AD%86%E8%A8%98", title:"裝箱備貨"}
    ],
    ORIGIN: { // 原味
      "500g-原味": "https://via.placeholder.com/800x600?text=%E5%8E%9F%E5%91%B3+500g",
      "1kg-原味": "https://via.placeholder.com/800x600?text=%E5%8E%9F%E5%91%B3+1kg"
    },
    FLAVOR: { // 蒜香/胡椒
      "500g-蒜香": "https://via.placeholder.com/800x600?text=%E8%92%9C%E9%A6%99+500g",
      "1kg-蒜香": "https://via.placeholder.com/800x600?text=%E8%92%9C%E9%A6%99+1kg",
      "500g-胡椒": "https://via.placeholder.com/800x600?text=%E8%83%A1%E6%A4%92+500g",
      "1kg-胡椒": "https://via.placeholder.com/800x600?text=%E8%83%A1%E6%A4%92+1kg"
    }
  },

  INVENTORY: {
    "ORI05-PLN":{sold:12, stock:999},
    "ORI10-PLN":{sold:9, stock:0},
    "FLV05-GAR":{sold:34, stock:88},
    "FLV10-GAR":{sold:5, stock:12},
    "FLV05-PEP":{sold:18, stock:0},
    "FLV10-PEP":{sold:2, stock:7}
  }
};

// 轉 raw.githubusercontent（GitHub/一般網址皆可）：
function toRaw(u){
  if(!u) return u;
  if(u.includes('raw.githubusercontent.com')) return u;
  if(u.includes('github.com')){
    return u.replace('https://github.com/','https://raw.githubusercontent.com/').replace('/blob/','/');
  }
  return u; // 非 GitHub 保持原樣
}
</script>

<!-- 一鍵截圖用（不影響頁面，CDN 可換） -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- ====== 第 2 部分 JS 續上 ====== -->
<script>
/***********************
 * 工具與資料存取
 ***********************/
const LS = {
  cart:'ks_cart',
  shipMethod:'ks_ship_method',
  form:'ks_form',
  inventory:'ks_inventory',
  overrides:'ks_overrides'
};

const ADMIN = {
  LS_KEY:'ks_admin_login',
  USER:'111111',
  PASS:'111111',
  logged(){ try{return JSON.parse(localStorage.getItem(this.LS_KEY))?.ok;}catch{return false} },
  save(ok){ localStorage.setItem(this.LS_KEY, JSON.stringify({ok:!!ok, ts:Date.now()})); }
};

/***********************
 * 商品清單（可被面板覆寫）
 ***********************/
const ORIGIN = [
  { id:"ORI05-PLN", section:"ORIGIN", title:"菱角酥｜原味 500g", weight:"500g", size:"原味" },
  { id:"ORI10-PLN", section:"ORIGIN", title:"菱角酥｜原味 1kg",  weight:"1kg",  size:"原味" }
];
const FLAVOR = [
  { id:"FLV05-GAR", section:"FLAVOR", title:"菱角酥｜蒜香 500g", weight:"500g", size:"蒜香" },
  { id:"FLV10-GAR", section:"FLAVOR", title:"菱角酥｜蒜香 1kg",  weight:"1kg",  size:"蒜香" },
  { id:"FLV05-PEP", section:"FLAVOR", title:"菱角酥｜胡椒 500g", weight:"500g", size:"胡椒" },
  { id:"FLV10-PEP", section:"FLAVOR", title:"菱角酥｜胡椒 1kg",  weight:"1kg",  size:"胡椒" }
];
const ALL_PRODUCTS = ()=>[...ORIGIN, ...FLAVOR];

/***********************
 * 金額與圖片工具
 ***********************/
const priceOf = (section,weight,size)=> CONFIG.PRICES[section]?.[weight]?.[size] ?? 0;
const currency = n => "NT$ "+(n||0).toLocaleString();
const imgFor = (section,weight,size)=> CONFIG.IMAGES[section]?.[`${weight}-${size}`]
  || 'https://via.placeholder.com/800x600?text=Image';

/***********************
 * 覆寫儲存/載入
 ***********************/
function collectTitles(){
  const t={};
  ALL_PRODUCTS().forEach(p=>t[p.id]=p.title);
  return t;
}
function applyTitles(map){
  ALL_PRODUCTS().forEach(p=>{ if(map[p.id]) p.title = map[p.id]; });
}
function saveOverrides(){
  const map = {
    PRICES: CONFIG.PRICES,
    IMAGES: CONFIG.IMAGES,
    TEXTS:  CONFIG.TEXTS,
    INVENTORY: INV,
    TITLES: collectTitles(),
    GALLERY: CONFIG.IMAGES.SPEC_GALLERY,
    NEWS: CONFIG.IMAGES.NEWS
  };
  localStorage.setItem(LS.overrides, JSON.stringify(map));
}
function loadOverrides(){
  try{
    const s = localStorage.getItem(LS.overrides);
    if(!s) return;
    const o = JSON.parse(s);
    if(o.PRICES) CONFIG.PRICES = o.PRICES;
    if(o.IMAGES) CONFIG.IMAGES = o.IMAGES;
    if(o.TEXTS)  CONFIG.TEXTS  = o.TEXTS;
    if(o.INVENTORY) INV = o.INVENTORY;
    if(o.TITLES) applyTitles(o.TITLES);
    if(o.GALLERY) CONFIG.IMAGES.SPEC_GALLERY = o.GALLERY;
    if(o.NEWS)    CONFIG.IMAGES.NEWS = o.NEWS;
  }catch{}
}

/***********************
 * 前端庫存（含售完）
 ***********************/
let INV = (()=>{
  try{
    const s = localStorage.getItem(LS.inventory);
    return s ? JSON.parse(s) : JSON.parse(JSON.stringify(CONFIG.INVENTORY));
  }catch{ return JSON.parse(JSON.stringify(CONFIG.INVENTORY)); }
})();
function saveInventory(){ localStorage.setItem(LS.inventory, JSON.stringify(INV)); }
let invEditMode = false;
function toggleInvEdit(){
  if(!ADMIN.logged()){ toggleAdmin(true); return; }
  invEditMode = !invEditMode; renderAllGrids();
}

/***********************
 * 購物車
 ***********************/
const cart = (()=>{
  try{ return JSON.parse(localStorage.getItem(LS.cart)||'[]'); }catch{return []}
})();
function saveCart(){ localStorage.setItem(LS.cart, JSON.stringify(cart)); }
function addToCart(pid){
  const src = ALL_PRODUCTS().find(x=>x.id===pid);
  if(!src) return;
  const inv = INV[pid]||{sold:0,stock:0};
  if(inv.stock<=0){ showToast('此品項已售完'); return; }

  const price = priceOf(src.section, src.weight, src.size);
  const existed = cart.find(x=>x.id===pid);
  if(existed) existed.qty++;
  else cart.push({ id:src.id, title:src.title, price, qty:1, weight:src.weight, size:src.size, section:src.section });
  saveCart(); renderCart();
  showToast('已加入購物車'); // 不自動開抽屜
}
function mutateQty(i,delta){
  cart[i].qty += delta;
  if(cart[i].qty<=0) cart.splice(i,1);
  saveCart(); renderCart();
}
function clearCart(){
  if(!cart.length) return;
  if(confirm('確定要清空購物車？')){
    cart.length = 0; saveCart(); renderCart();
  }
}
function calc(){
  const method = getShipMethod();
  const subtotal = cart.reduce((s,i)=>s+i.price*i.qty,0);
  let shipping = method==='CVS' ? 0 : ((subtotal>=CONFIG.FREE_SHIP_THRESHOLD || cart.length===0) ? 0 : CONFIG.SHIPPING);
  return {subtotal, shipping, total: subtotal+shipping};
}
function renderCart(){
  const list = document.getElementById('cartList');
  if(!cart.length){
    list.innerHTML = `<div class="muted">購物車是空的，來點酥香吧 🍊</div>`;
  }else{
    list.innerHTML = cart.map((c,i)=>`
      <div class="cart-row">
        <div>
          <div><strong>${c.title}</strong></div>
          <div class="note">${currency(c.price)} × ${c.qty}</div>
        </div>
        <div class="qty">
          <button aria-label="減少" onclick="mutateQty(${i},-1)">–</button>
          <span>${c.qty}</span>
          <button aria-label="增加" onclick="mutateQty(${i},1)">＋</button>
        </div>
      </div>`).join('');
  }
  const {subtotal,shipping,total} = calc();
  document.getElementById('subtotal').textContent = currency(subtotal);
  document.getElementById('shipping').textContent = currency(shipping);
  document.getElementById('total').textContent = currency(total);
  document.getElementById('fabCount').textContent = cart.reduce((s,i)=>s+i.qty,0);

  const method = getShipMethod();
  document.getElementById('shipLabel').textContent = method==='CVS' ? '運費（超商取貨｜免運）' : '運費（宅配）';

  const shipSel = document.querySelector('select[name="ship"]');
  if(shipSel){ shipSel.value = method==='CVS' ? '超商取貨' : '宅配'; }

  document.getElementById('homeFields').style.display = (method==='HOME') ? 'block':'none';
  document.getElementById('cvsFields').style.display  = (method==='CVS')  ? 'block':'none';
  document.querySelector('input[name="addr"]')?.toggleAttribute('required', method==='HOME');
}

/***********************
 * 配送方式與選門市
 ***********************/
function toggleDrawer(open){ document.getElementById('drawer').classList.toggle('open', !!open); }
function toggleQuery(open){ document.getElementById('queryDrawer').classList.toggle('open', !!open); }
function getShipMethod(){ return localStorage.getItem(LS.shipMethod) || 'HOME'; }
function setShipMethod(m){
  if(m==='CVS'){
    const ok = cart.length===1 && cart[0].qty===1; // 放寬為任一單一商品一箱
    if(!ok){ alert('超商取貨限「單一商品 × 1 箱」。請調整購物車後再選擇。'); m = 'HOME'; }
  }
  localStorage.setItem(LS.shipMethod, m);
  document.getElementById('shipHomeBtn').className = (m==='HOME') ? 'btn' : 'btn-ghost';
  document.getElementById('shipCvsBtn').className  = (m==='CVS')  ? 'btn' : 'btn-ghost';
  renderCart();
}
// 依品牌切換官方查詢（以新視窗開啟）
function updateCvsLink(){
  const brand = document.querySelector('select[name="cvsBrand"]').value;
  const a = document.getElementById('cvsFinderLink');
  if(brand==='全家'){
    a.href = 'https://www.family.com.tw/marketing/inquiry.aspx';
    a.textContent = '開啟 全家 門市查詢（新視窗）';
  }else{
    a.href = 'https://emap.pcsc.com.tw/';
    a.textContent = '開啟 7-11 門市查詢（新視窗）';
  }
  a.target = '_blank'; a.rel='noopener';
}

// 從剪貼簿貼回選到的門市（使用者手動複製官方頁的資訊/連結）
async function pasteCvsFromClipboard(){
  try{
    const txt = await navigator.clipboard.readText();
    if(!txt){ alert('剪貼簿沒有內容'); return; }
    const parsed = parseStoreFromText(txt);
    document.querySelector('input[name="cvsStore"]').value =
      parsed ? `${parsed.name} / ${parsed.code}` : txt.trim();
  }catch(e){
    alert('無法讀取剪貼簿：' + e.message + '（請先允許權限）');
  }
}
function parseStoreFromText(txt){
  const code = (txt.match(/(\d{5,6})/)||[])[1];
  const name = (txt.match(/([\u4e00-\u9fa5A-Za-z0-9]+門市)/)||[])[1]
            || (txt.match(/店名[:：]?\s*([\u4e00-\u9fa5A-Za-z0-9]+)/)||[])[1]
            || (txt.replace(/\s+/g,' ').trim().split(/[\/,，-]/)[0]||'門市');
  if(code){ return {name, code}; }
  return null;
}

/***********************
 * UI：渲染內容與產品卡
 ***********************/
function productCard(p){
  const price = priceOf(p.section, p.weight, p.size);
  const img = imgFor(p.section, p.weight, p.size);
  const inv = INV[p.id] || {sold:0,stock:999};
  const isHot = p.weight==='1kg'; // 1kg 常被視為熱銷
  const editable = ADMIN.logged();

  const soldHtml = inv.stock<=0 ? `<div class="sold-badge">已售完</div>` : '';
  const buyBtn   = inv.stock<=0
    ? `<button class="btn btn-block" disabled>已售完</button>`
    : `<button class="btn btn-block" onclick="addToCart('${p.id}')" aria-label="加入購物車">購買</button>`;

  return `
  <article class="product card">
    <div class="imgwrap">
      <img src="${img}" alt="${p.title}">
      ${soldHtml}
    </div>
    <div class="body">
      <div class="row-between" style="gap:8px">
        <h3 class="title" ${editable?'contenteditable="true" onblur="editTitle(\''+p.id+'\', this.textContent.trim())"':''}>${p.title}</h3>
        ${isHot ? '<span class="tag-hot" aria-label="熱銷">🔥 熱銷</span>' : ''}
      </div>

      <div class="note" style="margin-top:6px">已售出 ${inv.sold}　剩餘 ${inv.stock} 包</div>

      <div class="price" style="margin:6px 0 10px">
        ${editable
          ? `<input type="number" value="${price}" style="width:120px" onblur="setPrice('${p.section}','${p.weight}','${p.size}', this.value)">`
          : `${currency(price)}`
        }
      </div>

      ${editable ? `
      <div class="note" style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin:6px 0 10px">
        <span>圖片網址</span>
        <input type="url" value="${img}" style="flex:1;min-width:140px" onblur="setImage('${p.section}','${p.weight}','${p.size}', this.value)">
      </div>` : ''}

      ${buyBtn}

      ${invEditMode ? `
        <div class="note" style="margin-top:8px;display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <span>已售出</span><input type="number" min="0" value="${inv.sold}" style="width:80px" onchange="editInv('${p.id}','sold',this.value)">
          <span>剩餘</span><input type="number" min="0" value="${inv.stock}" style="width:80px" onchange="editInv('${p.id}','stock',this.value)">
        </div>` : ''
      }
    </div>
  </article>`;
}
function editTitle(id, val){
  const item = ALL_PRODUCTS().find(x=>x.id===id);
  if(item){ item.title = val || item.title; saveOverrides(); renderAllGrids(); }
}
function setPrice(section,weight,size,val){
  if(!CONFIG.PRICES[section]) CONFIG.PRICES[section]={};
  if(!CONFIG.PRICES[section][weight]) CONFIG.PRICES[section][weight]={};
  CONFIG.PRICES[section][weight][size] = Math.max(0, parseInt(val||0));
  saveOverrides();
}
function setImage(section,weight,size,url){
  if(!CONFIG.IMAGES[section]) CONFIG.IMAGES[section]={};
  CONFIG.IMAGES[section][`${weight}-${size}`] = toRaw(url.trim());
  saveOverrides(); renderAllGrids();
}
function editInv(id,key,val){
  if(!INV[id]) INV[id]={sold:0,stock:0};
  INV[id][key] = Math.max(0, parseInt(val||0));
  saveInventory(); renderAllGrids();
}

function renderGrid(elId, items){
  const el = document.getElementById(elId);
  el.innerHTML = items.map(productCard).join('');
}
function renderAllGrids(){
  const HOT = ALL_PRODUCTS().filter(p=>(INV[p.id]?.stock||0)>0 && p.weight==='1kg');
  renderGrid('hotGrid', HOT.length?HOT:ALL_PRODUCTS().slice(0,2));
  renderGrid('ponganGrid', ORIGIN);
  renderGrid('maogaoGrid', FLAVOR);
}

function renderSpecRail(){
  const rail = document.getElementById('specRail');
  rail.innerHTML = CONFIG.IMAGES.SPEC_GALLERY.map(src=>`
    <div class="card"><img src="${toRaw(src)}" alt="規格與口味" style="width:100%;height:auto;display:block;border-radius:16px"></div>
  `).join('');
}
function renderNewsRail(){
  const rail = document.getElementById('newsRail');
  rail.innerHTML = CONFIG.IMAGES.NEWS.map(item=>{
    if(item.type==='video'){
      return `<div class="card" style="overflow:hidden"><video src="${toRaw(item.src)}" controls style="width:100%;height:100%;display:block"></video><div class="content" style="padding:10px">${item.title||''}</div></div>`;
    }else{
      return `<div class="card"><img src="${toRaw(item.src)}" alt="${item.title||''}" style="width:100%;height:auto;display:block;border-radius:16px 16px 0 0"><div class="content" style="padding:10px">${item.title||''}</div></div>`;
    }
  }).join('');
}
function renderTextsAndImages(){
  // hero / logo
  document.getElementById('hero').style.backgroundImage = `url('${toRaw(CONFIG.IMAGES.HERO)}')`;
  document.getElementById('logoImg').src = toRaw(CONFIG.IMAGES.LOGO);
  document.getElementById('heroPill').textContent = CONFIG.TEXTS.heroPill;
  document.getElementById('heroTitle').textContent = CONFIG.TEXTS.heroTitle;
  document.getElementById('heroSub').textContent = CONFIG.TEXTS.heroSub;
  document.getElementById('shopNowBtn').textContent = CONFIG.TEXTS.ctaLabel;

  // chips
  const rail = document.getElementById('chipRail');
  rail.innerHTML = `
    <button class="chip" onclick="go(event,'hot')">${CONFIG.TEXTS.chips[0]||'熱銷款'}</button>
    <button class="chip" onclick="go(event,'pongan')">${CONFIG.TEXTS.chips[1]||'經典原味'}</button>
    <button class="chip" onclick="go(event,'maogao')">${CONFIG.TEXTS.chips[2]||'蒜香/胡椒'}</button>
    <button class="chip" onclick="toggleQuery(true)">${CONFIG.TEXTS.chips[3]||'訂單查詢'}</button>`;

  // about/spec/hot/sections
  document.getElementById('aboutTitle').textContent = CONFIG.TEXTS.aboutTitle;
  document.getElementById('aboutP1').textContent   = CONFIG.TEXTS.aboutP1;
  document.getElementById('aboutP2').textContent   = CONFIG.TEXTS.aboutP2;
  document.getElementById('aboutP3').textContent   = CONFIG.TEXTS.aboutP3;
  document.getElementById('newsTitle').textContent = CONFIG.TEXTS.newsTitle;
  document.getElementById('specTitle').textContent = CONFIG.TEXTS.specTitle;
  document.getElementById('specSub').textContent   = CONFIG.TEXTS.specSub;
  document.getElementById('hotTitle').textContent  = CONFIG.TEXTS.hotTitle;
  document.getElementById('hotSub').textContent    = CONFIG.TEXTS.hotSub;
  document.getElementById('sec1Title').textContent = CONFIG.TEXTS.sec1Title;
  document.getElementById('sec1Sub').textContent   = CONFIG.TEXTS.sec1Sub;
  document.getElementById('sec2Title').textContent = CONFIG.TEXTS.sec2Title;
  document.getElementById('sec2Sub').textContent   = CONFIG.TEXTS.sec2Sub;

  // bank info
  document.getElementById('bankName').textContent   = CONFIG.BANK.name;
  document.getElementById('bankHolder').textContent = CONFIG.BANK.holder;
  document.getElementById('bankNo').textContent     = CONFIG.BANK.no;
  document.getElementById('freeShipText').textContent = 'NT$ ' + CONFIG.FREE_SHIP_THRESHOLD.toLocaleString();

  renderNewsRail();
  renderSpecRail();
}

/***********************
 * 平滑捲動／表單記憶
 ***********************/
function go(e,id){
  if(e) e.preventDefault();
  const el = document.getElementById(id); if(!el) return;
  const navH = document.querySelector('.subnav')?.offsetHeight || 0;
  const y = el.getBoundingClientRect().top + window.scrollY - navH - 6;
  window.scrollTo({top:y,behavior:'smooth'});
}
function saveForm(){
  const f = document.getElementById('orderForm');
  const obj = Object.fromEntries(new FormData(f));
  obj.shipMethod = getShipMethod();
  localStorage.setItem(LS.form, JSON.stringify(obj));
}
function loadForm(){
  try{
    const s = localStorage.getItem(LS.form);
    if(!s) return;
    const obj = JSON.parse(s);
    const f = document.getElementById('orderForm');
    for(const k in obj){ if(f[k]) f[k].value = obj[k]; }
    setShipMethod(obj.shipMethod || 'HOME');
  }catch{}
}
document.getElementById('orderForm').addEventListener('input', saveForm);

/***********************
 * 提交訂單 / 訂單查詢
 ***********************/
async function submitOrder(ev){
  ev.preventDefault();
  if(!cart.length){ alert("購物車是空的"); return; }
  const agree = document.getElementById('agree');
  if(!agree.checked){ alert('請先閱讀「物流與退貨說明」並勾選同意'); return; }

  const f = new FormData(ev.target);
  f.set('ship', getShipMethod()==='CVS' ? '超商取貨' : f.get('ship'));
  const method = getShipMethod();

  if(method==='CVS'){
    const ok = cart.length===1 && cart[0].qty===1;
    if(!ok){ alert('超商取貨限「單一商品 × 1 箱」。'); return; }
  }

  for (const key of ['name','phone','email']){
    if(!f.get(key)){ alert('請完整填寫訂單資料'); return; }
  }
  if(method==='HOME' && !f.get('addr')){ alert('請填寫宅配地址'); return; }

  const payload = {
    ts: new Date().toISOString(),
    name: f.get('name'), phone: f.get('phone'), email: f.get('email'),
    addr: method==='CVS' ? `${f.get('cvsBrand')||''} ${f.get('cvsStore')||''}（超商取貨）` : (f.get('addr')||''),
    ship: method==='CVS' ? '超商取貨' : f.get('ship'),
    remark: f.get('remark')||'',
    items: cart.map(c=>({title:c.title, section:c.section, weight:c.weight, size:c.size, price:c.price, qty:c.qty})),
    summary: calc(),
    brand: CONFIG.BRAND_TAG,
    contact: CONFIG.CONTACT_EMAIL
  };

  const btn = document.getElementById('submitBtn');
  const resBox = document.getElementById('result');
  btn.disabled = true; btn.textContent = '送出訂單中，請稍等…'; resBox.textContent = '';

  try{
    const r = await fetch(CONFIG.GAS_ENDPOINT, {method:'POST', body: JSON.stringify(payload)});
    const data = await r.json();
    if(data.ok){
      resBox.innerHTML =
        `✅ 訂單已建立（編號：<b>${data.order_no}</b>）。<br>
         我們已把匯款資訊寄至 <b>${payload.email}</b>，請於 24 小時內完成匯款以保留庫存。`;
      cart.length = 0; saveCart(); renderCart();
      ev.target.reset(); saveForm();
    }else{
      resBox.textContent = '送出失敗：'+(data.msg||'未知錯誤');
    }
  }catch(e){
    resBox.textContent = '送出失敗：'+ e.message;
  }finally{
    btn.disabled = false; btn.textContent = '送出訂單';
  }
}

async function queryOrder(ev){
  ev.preventDefault();
  const f = new FormData(ev.target);
  const no = (f.get('orderNo')||'').trim();
  const card = document.getElementById('queryCard');
  const dlBtn = document.getElementById('dlPngBtn');
  const printBtn = document.getElementById('printBtn');
  card.style.display = 'block';
  card.innerHTML = '查詢中…';
  dlBtn.style.display = 'none';
  printBtn.style.display = 'none';

  try{
    const url = CONFIG.GAS_ENDPOINT + '?orderNo=' + encodeURIComponent(no);
    const r = await fetch(url);
    const data = await r.json();
    if(data.ok){
      const s = data.status || '（未提供狀態）';
      const total = data.total ? `NT$ ${(data.total||0).toLocaleString()}` : '—';
      const shipDate = data.shipDate || '—';
      const trackNo = data.trackingNo || '—';
      const trackLink = data.trackingNo ? `<a href="https://www.hct.com.tw/searchWaybill.aspx?no=${encodeURIComponent(data.trackingNo)}" target="_blank">新竹貨運查詢</a>` : '—';
      const items = Array.isArray(data.items) ? data.items.map(i=>`${i.title} × ${i.qty}`).join('、') : '—';

      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <h3 style="margin:0">訂單查詢結果</h3>
          <div class="note">${new Date().toLocaleString()}</div>
        </div>
        <div class="line" style="margin:10px 0"></div>
        <div><b>訂單編號：</b>${no}</div>
        <div><b>目前狀態：</b>${s}</div>
        <div><b>出貨日期：</b>${shipDate}</div>
        <div><b>物流單號：</b>${trackNo}</div>
        <div><b>物流查詢：</b>${trackLink}</div>
        <div><b>金額：</b>${total}</div>
        <div><b>品項：</b>${items}</div>
        `;
      dlBtn.style.display = 'inline-flex';
      printBtn.style.display = 'inline-flex';
    }else{
      card.innerHTML = '查無此訂單編號';
    }
  }catch(e){
    card.innerHTML = '查詢失敗：' + e.message;
  }
}

/***********************
 * 一鍵截圖（訂單查詢卡片）
 ***********************/
async function downloadQueryPNG(){
  const card = document.getElementById('queryCard');
  if(!window.html2canvas){ alert('截圖工具載入中，請稍後再試'); return; }
  const canvas = await html2canvas(card, {scale:2});
  const url = canvas.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = url; a.download = 'order-query.png';
  a.click();
}

/***********************
 * 條款：展開並捲到底才可勾選
 ***********************/
(function setupPolicy(){
  const det = document.getElementById('policy');
  const agree = document.getElementById('agree');
  if(!det || !agree) return;
  const enableIfBottom = ()=>{
    const sc = det.scrollTop + det.clientHeight;
    const need = det.scrollHeight - 10;
    if(sc >= need){ agree.disabled = false; }
  };
  det.addEventListener('toggle', ()=>{ if(det.open){ det.focus(); }});
  det.addEventListener('scroll', enableIfBottom, {passive:true});
  document.querySelector('label[for="agree"]')?.addEventListener('click', (e)=>{
    if(agree.disabled){ e.preventDefault(); det.open=true; det.scrollIntoView({behavior:'smooth',block:'center'}); }
  });
})();

/***********************
 * Toast（加入購物車提示）
 ***********************/
function ensureToast(){
  if(document.getElementById('ksToast')) return;
  const t = document.createElement('div');
  t.id='ksToast';
  t.style.cssText = 'position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.2);z-index:70;opacity:0;pointer-events:none;transition:.25s';
  document.body.appendChild(t);
}
function showToast(msg){
  ensureToast();
  const t = document.getElementById('ksToast');
  t.textContent = msg;
  t.style.opacity = '1';
  t.style.pointerEvents = 'auto';
  setTimeout(()=>{ t.style.opacity='0'; t.style.pointerEvents='none'; }, 1600);
}

/***********************
 * Admin：登入/面板
 *（移除 GitHub Token，上線 URL 轉 RAW 轉換器）
 ***********************/
function toggleAdmin(open){
  const d = document.getElementById('adminDrawer');
  d.classList.toggle('open', !!open);
  renderAdmin();
}
function logoutAdmin(){ ADMIN.save(false); invEditMode=false; renderAdmin(); renderAllGrids(); }

function renderAdmin(){
  const box = document.getElementById('adminBody');
  if(!ADMIN.logged()){
    box.innerHTML = `
      <h3>管理員登入</h3>
      <div class="note">帳密將記憶在此裝置。</div>
      <div class="line"></div>
      <div class="form">
        <div class="label">帳號</div>
        <input class="input" id="admUser" placeholder="輸入帳號">
        <div class="label">密碼</div>
        <input class="input" id="admPass" type="password" placeholder="輸入密碼">
        <button class="btn" style="margin-top:10px" onclick="doAdminLogin()">登入</button>
      </div>`;
    return;
  }

  // 已登入：可編輯全站文字/圖片/輪播/商品與庫存、RAW 轉換器
  const txt = CONFIG.TEXTS;
  const img = CONFIG.IMAGES;
  const gallery = (CONFIG.IMAGES.SPEC_GALLERY||[]).map((u,i)=>`
    <div style="display:flex;gap:6px;align-items:center;margin:6px 0">
      <input class="input" id="gal_${i}" value="${u}" placeholder="圖片或影片網址">
      <button class="btn-ghost" onclick="adminMoveGallery(${i},-1)">↑</button>
      <button class="btn-ghost" onclick="adminMoveGallery(${i},1)">↓</button>
      <button class="btn-ghost" onclick="adminDelGallery(${i})">刪</button>
    </div>`).join('');

  const news = (CONFIG.IMAGES.NEWS||[]).map((it,i)=>`
    <div class="card content" style="margin:6px 0">
      <div class="row" style="grid-template-columns:1fr 1fr">
        <div>
          <div class="label">類型</div>
          <select class="input" id="news_type_${i}">
            <option value="image" ${it.type==='image'?'selected':''}>圖片</option>
            <option value="video" ${it.type==='video'?'selected':''}>影片</option>
          </select>
        </div>
        <div>
          <div class="label">標題</div>
          <input class="input" id="news_title_${i}" value="${it.title||''}">
        </div>
      </div>
      <div class="label">來源網址</div>
      <input class="input" id="news_src_${i}" value="${it.src||''}">
      <div style="margin-top:6px;display:flex;gap:6px">
        <button class="btn-ghost" onclick="adminMoveNews(${i},-1)">↑</button>
        <button class="btn-ghost" onclick="adminMoveNews(${i},1)">↓</button>
        <button class="btn-ghost" onclick="adminDelNews(${i})">刪</button>
      </div>
    </div>`).join('');

  box.innerHTML = `
    <h3>站內內容管理</h3>
    <div class="line"></div>

    <h4>首頁 / 品牌</h4>
    <div class="row">
      <div>
        <div class="label">封面背景（HERO）</div>
        <input class="input" id="admHero" value="${img.HERO||''}">
      </div>
      <div>
        <div class="label">品牌標誌（LOGO）</div>
        <input class="input" id="admLogo" value="${img.LOGO||''}">
      </div>
    </div>

    <div class="row">
      <div>
        <div class="label">封面角標</div>
        <input class="input" id="txtHeroPill" value="${txt.heroPill||''}">
      </div>
      <div>
        <div class="label">按鈕文字</div>
        <input class="input" id="txtCta" value="${txt.ctaLabel||''}">
      </div>
    </div>

    <div class="label">封面標題</div>
    <input class="input" id="txtHeroTitle" value="${txt.heroTitle||''}">
    <div class="label">封面副標</div>
    <textarea class="input" id="txtHeroSub" rows="2">${txt.heroSub||''}</textarea>

    <div class="line"></div>
    <h4>導覽籤（依序）</h4>
    <div class="row">
      ${(txt.chips||[]).map((c,i)=>`
        <div>
          <div class="label">籤 ${i+1}</div>
          <input class="input" id="chip_${i}" value="${c}">
        </div>`).join('')}
    </div>

    <div class="line"></div>
    <h4>段落標題</h4>
    <div class="row">
      <div><div class="label">關於我們</div><input class="input" id="txtAbout" value="${txt.aboutTitle||''}"></div>
      <div><div class="label">最新鮮報</div><input class="input" id="txtNews" value="${txt.newsTitle||''}"></div>
    </div>
    <div class="row">
      <div><div class="label">規格主標</div><input class="input" id="txtSpec" value="${txt.specTitle||''}"></div>
      <div><div class="label">規格副標</div><input class="input" id="txtSpecSub" value="${txt.specSub||''}"></div>
    </div>
    <div class="row">
      <div><div class="label">熱銷主標</div><input class="input" id="txtHot" value="${txt.hotTitle||''}"></div>
      <div><div class="label">熱銷副標</div><input class="input" id="txtHotSub" value="${txt.hotSub||''}"></div>
    </div>

    <div class="label">關於我們段落</div>
    <textarea class="input" id="txtAboutP1" rows="2">${txt.aboutP1||''}</textarea>
    <textarea class="input" id="txtAboutP2" rows="2" style="margin-top:6px">${txt.aboutP2||''}</textarea>
    <textarea class="input" id="txtAboutP3" rows="2" style="margin-top:6px">${txt.aboutP3||''}</textarea>

    <div class="line"></div>
    <h4>規格/口味圖（卡片輪播）</h4>
    ${gallery}
    <button class="btn-ghost" style="margin-top:6px" onclick="adminAddGallery()">＋ 新增</button>

    <div class="line"></div>
    <h4>最新鮮報（圖片/影片）</h4>
    ${news}
    <button class="btn-ghost" style="margin-top:6px" onclick="adminAddNews()">＋ 新增</button>

    <div class="line"></div>
    <h4>URL 轉 RAW 工具（貼上 GitHub / GDrive 等網址）</h4>
    <div class="row">
      <div>
        <div class="label">原網址</div>
        <input class="input" id="rawSrc" placeholder="貼上要轉換的網址">
      </div>
      <div>
        <div class="label">RAW 結果</div>
        <input class="input" id="rawOut" readonly placeholder="轉換結果會顯示於此">
      </div>
    </div>
    <div style="margin-top:6px;display:flex;gap:6px">
      <button class="btn-ghost" onclick="doRawConvert()">轉換</button>
      <button class="btn-ghost" onclick="copyRaw()">複製結果</button>
    </div>

    <div class="line"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" onclick="adminSave()">儲存修改</button>
      <button class="btn-ghost" onclick="toggleInvEdit()">${invEditMode?'關閉':'開啟'}庫存欄位</button>
    </div>
  `;
}

function doAdminLogin(){
  const u = document.getElementById('admUser').value.trim();
  const p = document.getElementById('admPass').value.trim();
  if(u===ADMIN.USER && p===ADMIN.PASS){ ADMIN.save(true); alert('登入成功'); renderAdmin(); }
  else alert('帳密錯誤');
}

/***********************
 * Admin：RAW 轉換器
 ***********************/
if(typeof toRaw!=='function'){
  function toRaw(u){
    if(!u) return u;
    // GitHub blob → raw
    if(u.includes('github.com/') && u.includes('/blob/')){
      return u.replace('https://github.com/','https://raw.githubusercontent.com/').replace('/blob/','/');
    }
    // GitHub tree content API raw 手動不處理；維持原樣
    // Google Drive share → uc 直連
    const m = u.match(/drive\.google\.com\/file\/d\/([^/]+)/);
    if(m){ return `https://drive.google.com/uc?export=download&id=${m[1]}`; }
    return u;
  }
}
function doRawConvert(){
  const src = document.getElementById('rawSrc').value.trim();
  document.getElementById('rawOut').value = toRaw(src);
}
function copyRaw(){
  const v = document.getElementById('rawOut').value;
  if(!v){ alert('沒有內容可複製'); return; }
  navigator.clipboard.writeText(v).then(()=>showToast('已複製 RAW 連結'));
}

/***********************
 * Admin：Gallery / News 編輯
 ***********************/
function adminAddGallery(){
  CONFIG.IMAGES.SPEC_GALLERY.push('');
  renderAdmin();
}
function adminDelGallery(i){
  CONFIG.IMAGES.SPEC_GALLERY.splice(i,1);
  renderAdmin();
}
function adminMoveGallery(i,dir){
  const j=i+dir; if(j<0||j>=CONFIG.IMAGES.SPEC_GALLERY.length) return;
  const a=CONFIG.IMAGES.SPEC_GALLERY; [a[i],a[j]]=[a[j],a[i]];
  renderAdmin();
}

function adminAddNews(){
  CONFIG.IMAGES.NEWS.push({type:'image', src:'', title:''});
  renderAdmin();
}
function adminDelNews(i){
  CONFIG.IMAGES.NEWS.splice(i,1); renderAdmin();
}
function adminMoveNews(i,dir){
  const j=i+dir; if(j<0||j>=CONFIG.IMAGES.NEWS.length) return;
  const a=CONFIG.IMAGES.NEWS; [a[i],a[j]]=[a[j],a[i]];
  renderAdmin();
}

function adminSave(){
  // 文字
  CONFIG.TEXTS.heroPill  = document.getElementById('txtHeroPill')?.value || CONFIG.TEXTS.heroPill;
  CONFIG.TEXTS.heroTitle = document.getElementById('txtHeroTitle')?.value || CONFIG.TEXTS.heroTitle;
  CONFIG.TEXTS.heroSub   = document.getElementById('txtHeroSub')?.value || CONFIG.TEXTS.heroSub;
  CONFIG.TEXTS.ctaLabel  = document.getElementById('txtCta')?.value || CONFIG.TEXTS.ctaLabel;

  CONFIG.TEXTS.chips = [
    document.getElementById('chip_0')?.value || '熱銷款',
    document.getElementById('chip_1')?.value || '經典原味',
    document.getElementById('chip_2')?.value || '蒜香/胡椒',
    document.getElementById('chip_3')?.value || '訂單查詢'
  ];

  CONFIG.TEXTS.aboutTitle = document.getElementById('txtAbout')?.value || CONFIG.TEXTS.aboutTitle;
  CONFIG.TEXTS.newsTitle  = document.getElementById('txtNews')?.value || CONFIG.TEXTS.newsTitle;
  CONFIG.TEXTS.specTitle  = document.getElementById('txtSpec')?.value || CONFIG.TEXTS.specTitle;
  CONFIG.TEXTS.specSub    = document.getElementById('txtSpecSub')?.value || CONFIG.TEXTS.specSub;
  CONFIG.TEXTS.hotTitle   = document.getElementById('txtHot')?.value || CONFIG.TEXTS.hotTitle;
  CONFIG.TEXTS.hotSub     = document.getElementById('txtHotSub')?.value || CONFIG.TEXTS.hotSub;

  CONFIG.TEXTS.aboutP1 = document.getElementById('txtAboutP1')?.value || CONFIG.TEXTS.aboutP1;
  CONFIG.TEXTS.aboutP2 = document.getElementById('txtAboutP2')?.value || CONFIG.TEXTS.aboutP2;
  CONFIG.TEXTS.aboutP3 = document.getElementById('txtAboutP3')?.value || CONFIG.TEXTS.aboutP3;

  // 圖片
  CONFIG.IMAGES.HERO = toRaw(document.getElementById('admHero')?.value || CONFIG.IMAGES.HERO);
  CONFIG.IMAGES.LOGO = toRaw(document.getElementById('admLogo')?.value || CONFIG.IMAGES.LOGO);

  // Gallery
  const newGal=[];
  (CONFIG.IMAGES.SPEC_GALLERY||[]).forEach((_,i)=>{
    const v = document.getElementById(`gal_${i}`)?.value || '';
    if(v) newGal.push(v.trim());
  });
  CONFIG.IMAGES.SPEC_GALLERY = newGal;

  // News
  const newNews=[];
  (CONFIG.IMAGES.NEWS||[]).forEach((_,i)=>{
    const type = document.getElementById(`news_type_${i}`)?.value || 'image';
    const title= document.getElementById(`news_title_${i}`)?.value || '';
    const src  = document.getElementById(`news_src_${i}`)?.value || '';
    if(src) newNews.push({type, title, src});
  });
  CONFIG.IMAGES.NEWS = newNews;

  saveOverrides();
  renderTextsAndImages();
  renderAllGrids();
  showToast('已儲存並套用');
}

/***********************
 * 初始化
 ***********************/
function initKS(){
  loadOverrides();
  renderTextsAndImages();
  setShipMethod(getShipMethod());
  renderCart();
  renderAllGrids();
  loadForm();
  updateCvsLink();
  // 橘子樣式 FAB（如果需要替換圖示，可在此修改）
  const fab = document.getElementById('cartFab');
  if(fab && !fab.dataset.kso){
    fab.innerHTML = `🍊 購物車 <span id="fabCount" class="fab-badge">0</span>`;
    fab.dataset.kso = '1';
  }
}
document.addEventListener('DOMContentLoaded', initKS);
